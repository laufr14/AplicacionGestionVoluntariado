
USE MASTER
CREATE DATABASE DATABASEVOLUNTARIADO
GO
USE DATABASEVOLUNTARIADO


--TABLAS
CREATE TABLE ALUMNADO_INSCRITO (
    DNI NVARCHAR(9) PRIMARY KEY,
    NOMBRE NVARCHAR(25) NOT NULL,
    PRIMER_APELLIDO NVARCHAR(25) NOT NULL,
    SEGUNDO_APELLIDO NVARCHAR(25) NOT NULL,
    CORREO_ELECTRONICO NVARCHAR(25) NOT NULL,
    TELEFONO NVARCHAR(9) NOT NULL,
    FECHA_NACIMIENTO DATETIME NOT NULL CHECK (FECHA_NACIMIENTO<GETDATE()),
    NOMBRE_CURSO NVARCHAR(10) NOT NULL
)



CREATE TABLE ACTIVIDADES (
    IDPROYECTO SMALLINT,
	IDACTIVIDAD SMALLINT,
    NOMBRE NVARCHAR(25) NOT NULL,
    DESCRIPCION TEXT NOT NULL,
    UBICACION NVARCHAR(255) NOT NULL,
    FECHA_INICIO DATETIME NOT NULL,
	FECHA_FIN DATETIME,
	PRIMARY KEY (IDPROYECTO, IDACTIVIDAD)
)

CREATE TABLE ALUMNO_ACTIVIDAD (
    DNI NVARCHAR(9), 
    IDPROYECTO SMALLINT,
	IDACTIVIDAD SMALLINT,
	PRIMARY KEY (DNI, IDPROYECTO, IDACTIVIDAD)
)


CREATE TABLE PROYECTOS_TIPOS(
IDPROYECTO SMALLINT,
NOMBRE_TIPO NVARCHAR(25)
PRIMARY KEY (IDPROYECTO, NOMBRE_TIPO)
)


CREATE TABLE PROYECTO_ODS(
IDPROYECTO SMALLINT,
IDODS SMALLINT
PRIMARY KEY (IDPROYECTO, IDODS)
)

CREATE TABLE TIPO(
NOMBRE NVARCHAR(25) PRIMARY KEY
)


CREATE TABLE PROYECTOS(
IDPROYECTO SMALLINT PRIMARY KEY,
NOMBRE_PROYECTO NVARCHAR(25) NOT NULL,
DESCRIPCION NVARCHAR(255) NOT NULL,
FECHA_INICIO DATETIME NOT NULL,
FECHA_FIN DATETIME,
ESTADO BIT NOT NULL,
IDORGANIZACION SMALLINT NOT NULL
)


CREATE TABLE ODS(
IDODS SMALLINT PRIMARY KEY,
NOMBRE NVARCHAR(50) NOT NULL,
DESCRIPCION TEXT NOT NULL,
)


CREATE TABLE ORGANIZACIONES(
IDORGANIZACION SMALLINT IDENTITY(1,1) PRIMARY KEY,
CIF NVARCHAR(9) NOT NULL,
NOMBRE NVARCHAR(25) NOT NULL,
DIRECCION NVARCHAR(255) NOT NULL,
TELEFONO CHAR(9) NOT NULL,
CORREO NVARCHAR(25) NOT NULL
)


CREATE TABLE CURSOS(
NOMBRE NVARCHAR(10) PRIMARY KEY,
)


CREATE TABLE ALUMNO_TIPO (
DNI NVARCHAR(9),
NOMBRE_TIPO NVARCHAR(25)
PRIMARY KEY (DNI, NOMBRE_TIPO)
)


CREATE TABLE HORARIO ( 
IDHORARIO INT IDENTITY(1,1),
DNI NVARCHAR(9),
DIA_SEMANA NVARCHAR(10) NOT NULL,
HORA_INICIO TIME NOT NULL,
HORA_FIN TIME NOT NULL
PRIMARY KEY (IDHORARIO, DNI)
)


--FOREIGN KEYS
ALTER TABLE ALUMNADO_INSCRITO
ADD CONSTRAINT FK_ALUMNADO_CURSOS FOREIGN KEY (NOMBRE_CURSO)
REFERENCES CURSOS(NOMBRE)

ALTER TABLE ACTIVIDADES
ADD CONSTRAINT FK_ACTIVIDADES_PROYECYOS FOREIGN KEY (IDPROYECTO)
REFERENCES PROYECTOS(IDPROYECTO)

ALTER TABLE ALUMNO_ACTIVIDAD
ADD CONSTRAINT FK_ALUMNOACTIVIDAD_ALUMNADO FOREIGN KEY (DNI)
REFERENCES ALUMNADO_INSCRITO(DNI)

ALTER TABLE ALUMNO_ACTIVIDAD
ADD CONSTRAINT FK_ALUMNOACTIVIDAD_PROYECTOS FOREIGN KEY (IDPROYECTO, IDACTIVIDAD)
REFERENCES ACTIVIDADES(IDPROYECTO, IDACTIVIDAD)

ALTER TABLE PROYECTOS_TIPOS
ADD CONSTRAINT FK_PROYECTOS_TIPOS_PROYECTOS
FOREIGN KEY (IDPROYECTO) REFERENCES PROYECTOS(IDPROYECTO)

ALTER TABLE PROYECTOS_TIPOS
ADD CONSTRAINT FK_PROYECTOS_TIPOS_TIPO
FOREIGN KEY (NOMBRE_TIPO) REFERENCES TIPO(NOMBRE)

ALTER TABLE PROYECTO_ODS 
ADD CONSTRAINT FK_PROYECTO_ODS_ODS 
FOREIGN KEY (IDODS) REFERENCES ODS(IDODS)

ALTER TABLE PROYECTO_ODS 
ADD CONSTRAINT FK_PROYECTO_ODS_PROYECTO
FOREIGN KEY (IDPROYECTO) REFERENCES PROYECTOS(IDPROYECTO)

ALTER TABLE PROYECTOS
ADD CONSTRAINT FK_PROYECTOS_CIF
FOREIGN KEY (IDORGANIZACION) REFERENCES ORGANIZACIONES(IDORGANIZACION)

ALTER TABLE ALUMNO_TIPO
ADD CONSTRAINT FK_ALUMNO_TIPO_DNI
FOREIGN KEY (DNI) REFERENCES ALUMNADO_INSCRITO(DNI)

ALTER TABLE ALUMNO_TIPO
ADD CONSTRAINT FK_ALUMNO_TIPO_TIPO
FOREIGN KEY (NOMBRE_TIPO) REFERENCES TIPO(NOMBRE)

ALTER TABLE HORARIO 
ADD CONSTRAINT FK_HORARIO_DNI
FOREIGN KEY (DNI) REFERENCES ALUMNADO_INSCRITO(DNI)

--CHECKS
ALTER TABLE PROYECTOS 
ADD CONSTRAINT CK_PROYECTOS_FECHAS CHECK (FECHA_FIN >= FECHA_INICIO)

ALTER TABLE ACTIVIDADES 
ADD CONSTRAINT CK_ACTIVIDADES_FECHAS CHECK (FECHA_FIN >= FECHA_INICIO)

ALTER TABLE HORARIO 
ADD CONSTRAINT CK_HORARIO_HORAS CHECK (HORA_FIN > HORA_INICIO)



--CREAR ÍNDICES PARA EL NOMBRE, APELLIDO1 Y APELLIDO2
CREATE INDEX IX_N_A_A ON ALUMNADO_INSCRITO (PRIMER_APELLIDO, SEGUNDO_APELLIDO,NOMBRE)

--OTROS ÍNDICES
CREATE UNIQUE INDEX IX_ALUMNADO_CORREO ON ALUMNADO_INSCRITO(CORREO_ELECTRONICO)
CREATE INDEX IX_ACTIVIDADES_NOMBRE ON ACTIVIDADES(NOMBRE)
CREATE INDEX IX_ORGANIZACIONES_NOMBRE ON ORGANIZACIONES(NOMBRE)
CREATE UNIQUE INDEX IX_PROYECTOS ON PROYECTOS(NOMBRE_PROYECTO)

--REGLA PARA EL DNI
GO
CREATE RULE DNIS AS (@CAMPO LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][A-Z]')
GO
EXEC SP_BINDRULE DNIS, 'ALUMNO_TIPO.DNI'
EXEC SP_BINDRULE DNIS, 'HORARIO.DNI'
EXEC SP_BINDRULE DNIS, 'ALUMNADO_INSCRITO.DNI'
EXEC SP_BINDRULE DNIS, 'ALUMNO_ACTIVIDAD.DNI'

--REGLA PARA EL CIF
GO
CREATE RULE CIF AS (@CAMPO LIKE '[A-Z][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
GO
EXEC SP_BINDRULE CIF, 'ORGANIZACIONES.CIF'

--REGLA PARA EL TELÉFONO
GO
CREATE RULE TELEFONO AS(@CAMPO LIKE '[6-7][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
GO
EXEC SP_BINDRULE TELEFONO, 'ALUMNADO_INSCRITO.TELEFONO'
EXEC SP_BINDRULE TELEFONO, 'ORGANIZACIONES.TELEFONO'

-- VALIDACIÓN DEL CORREO CON CHECK CONSTRAINT (No con RULE)
ALTER TABLE dbo.ALUMNADO_INSCRITO
ADD CONSTRAINT CK_CORREO_INSCRITO 
CHECK (CORREO_ELECTRONICO LIKE '%@%.%')

ALTER TABLE dbo.ORGANIZACIONES
ADD CONSTRAINT CK_CORREO_ORGANIZACIONES 
CHECK (CORREO LIKE '%@%.%')
GO

INSERT INTO ODS VALUES (1,'Fin de la pobreza','Erradicar la pobreza extrema en todas sus formas y en todo el mundo.')
INSERT INTO ODS VALUES (2,'Hambre cero','Garantizar el acceso a alimentos nutritivos y acabar con la desnutrición.')
INSERT INTO ODS VALUES (3,'Salud y bienestar','Asegurar una vida saludable y promover el bienestar para todos.')
INSERT INTO ODS VALUES (4,'Educación de calidad','Garantizar una educación inclusiva y equitativa para todos.')
INSERT INTO ODS VALUES (5,'Igualdad de género','Eliminar la discriminación y la violencia contra las mujeres y niñas.')
INSERT INTO ODS VALUES (6,'Agua limpia y saneamiento','Asegurar el acceso universal al agua potable y saneamiento.')
INSERT INTO ODS VALUES (7,'Energía asequible y no contaminante','Promover el acceso a energía sostenible y renovable.')
INSERT INTO ODS VALUES (8,'Trabajo decente y crecimiento económico','Fomentar empleos dignos y un desarrollo económico sostenible')
INSERT INTO ODS VALUES (9,'Industria, innovación e infraestructura',' Impulsar infraestructuras resilientes y tecnologías innovadoras.')
INSERT INTO ODS VALUES (10,'Reducción de las desigualdades','Disminuir la brecha económica y social dentro y entre los países.')
INSERT INTO ODS VALUES (11,'Ciudades y comunidades sostenibles','Crear ciudades inclusivas, seguras y sostenibles.')
INSERT INTO ODS VALUES (12,'Producción y consumo responsables','Fomentar el uso eficiente de los recursos y reducir los desechos.')
INSERT INTO ODS VALUES (13,'Acción por el clima','omar medidas urgentes para combatir el cambio climático.')
INSERT INTO ODS VALUES (14,'Vida submarina','Proteger los océanos y la biodiversidad marina.')
INSERT INTO ODS VALUES (15,'Vida de ecosistemas terrestres','Conservar bosques y detener la pérdida de biodiversidad.')
INSERT INTO ODS VALUES (16,'Paz, justicia e instituciones sólidas','Promover sociedades pacíficas y acceso a la justicia.')
INSERT INTO ODS VALUES (17,'Alianzas para lograr los objetivos','Fortalecer la cooperación global para alcanzar los ODS.')

INSERT INTO ORGANIZACIONES VALUES ('A12345678', 'Tech Solutions', 'Calle Mayor 12, Madrid', '611223344', 'info@techsolutions.com')
INSERT INTO ORGANIZACIONES VALUES ('B87654321', 'InnovaTech', 'Avenida Central 45, Barcelona', '632112233', 'contact@innovatech.com')
INSERT INTO ORGANIZACIONES VALUES ('G71082010', 'Asociación de Autismo', ' C. Blas de Laserna, 58, Pamplona', '675077977', 'coor@autismonavarra.com')
INSERT INTO ORGANIZACIONES VALUES ('A31660509', 'Amavir Navarra', 'Avda. de Guipúzcoa 5, Pamplona', '648153798', 'info@amavir.es')
INSERT INTO ORGANIZACIONES VALUES ('B71186654', 'Fundación Solera', 'C. Monasterio de Irache, 76, Pamplona', '648365252', 'funda@solera.es')

INSERT INTO TIPO VALUES ('Voluntariado Social')
INSERT INTO TIPO VALUES ('Voluntariado Ambiental')
INSERT INTO TIPO VALUES ('Voluntariado Educativo')
INSERT INTO TIPO VALUES ('Voluntariado Cultural')
INSERT INTO TIPO VALUES ('Voluntariado Deportivo')
INSERT INTO TIPO VALUES ('Voluntariado en Salud')
INSERT INTO TIPO VALUES ('Voluntariado Digital')

INSERT INTO CURSOS VALUES ('1TLA')
INSERT INTO CURSOS VALUES ('1TLB')
INSERT INTO CURSOS VALUES ('1CI')
INSERT INTO CURSOS VALUES ('1DAM')
INSERT INTO CURSOS VALUES ('1GVEC')
INSERT INTO CURSOS VALUES ('1ASIR')
INSERT INTO CURSOS VALUES ('1AF')
INSERT INTO CURSOS VALUES ('2TLA')
INSERT INTO CURSOS VALUES ('2TLB')
INSERT INTO CURSOS VALUES ('2CI')
INSERT INTO CURSOS VALUES ('2DAM')
INSERT INTO CURSOS VALUES ('2GVEC')
INSERT INTO CURSOS VALUES ('2ASIR')
INSERT INTO CURSOS VALUES ('2AF')

INSERT INTO ALUMNADO_INSCRITO VALUES ('12345678A','Sergio','De la Fuente','Marco','sergio4vientos@gmail.com','623456789','2003-17-12','1DAM')
INSERT INTO ALUMNADO_INSCRITO VALUES ('87654321B','Iker','Aramendia','Mars','ikeraramendia@gmail.com','687654321','2002-01-01','1TLA')
INSERT INTO ALUMNADO_INSCRITO VALUES ('23456789C','David','Martin','Jimenez','davidmartin@gmail.com','647258369','2006-02-02','2ASIR')
INSERT INTO ALUMNADO_INSCRITO VALUES ('98765432D','Laura','Felix','Gutierrez','laurafelix@gmail.com','763852741','1999-03-03','2TLB')
INSERT INTO ALUMNADO_INSCRITO VALUES ('34567891E', 'Laura', 'González', 'Martínez', 'laura.gm@email.com', '600123456', '2002-14-05', '2AF')
INSERT INTO ALUMNADO_INSCRITO VALUES ('19876543F', 'Carlos', 'Fernández', 'López', 'carlosfl@email.com', '699987654', '2001-30-11', '2GVEC')
INSERT INTO ALUMNADO_INSCRITO VALUES ('11223344C', 'Ana', 'Rodríguez', 'Santos', 'ana.rs@email.com', '611223344', '2003-22-03', '1CI')

INSERT INTO HORARIO VALUES ('12345678A','Lunes', '09:00', '12:00') 
INSERT INTO HORARIO VALUES ('87654321B','Miércoles', '14:00', '17:00')

INSERT INTO PROYECTOS VALUES (1, 'Desarrollo de App W', 'Creación de una plataforma de e-commerce', '2025-01-01', '2025-01-02', 'FALSE', 1)
INSERT INTO PROYECTOS VALUES (2, 'Ciberseguridad', 'Implementación de medidas de seguridad informática', '2025-01-02', '2025-01-03', 'FALSE',2)
INSERT INTO PROYECTOS VALUES (3, 'Voluntariado social', 'Acompañamiento de menores autistas', '2025-01-03', '2025-01-04', 'FALSE', 3)
INSERT INTO PROYECTOS VALUES (4, 'Voluntariado', 'Acompañamiento de ancianos', '2025-01-04', '2025-01-05', 'TRUE', 4)

INSERT INTO ACTIVIDADES VALUES (1, 1, 'Diseño UI/UX', 'Creación de la interfaz gráfica de la app', 'Madrid', '2025-02-01', '2025-03-01')
INSERT INTO ACTIVIDADES VALUES (1, 2, 'Desarrollo Backend', 'Programación de la lógica del servidor', 'Remoto', '2025-03-01', '2025-04-01')
INSERT INTO ACTIVIDADES VALUES (2, 1, 'Tercer', 'Tercera actividad del segundo proyecto', 'Pamplona', '2025-02-02', '2025-03-02')
INSERT INTO ACTIVIDADES VALUES (2, 2, 'Configuración cortafuegos', 'Implementación de firewall y reglas de acceso', 'Remoto', '2025-03-02', '2025-04-02')
INSERT INTO ACTIVIDADES VALUES (3, 1, 'Sesiones individuales', 'Juegos y apoyo emocional a menores', 'Pamplona', '2025-02-03', '2025-03-03')
INSERT INTO ACTIVIDADES VALUES (3, 2, 'Talleres', 'Actividades para mejorar la integración sensorial', 'Centro comunitario', '2025-03-03', '2025-06-03')
INSERT INTO ACTIVIDADES VALUES (4, 1, 'Visitas semanales', 'Charlas, juegos de mesa y lectura con ancianos', 'Residencia Amavir', '2025-02-04', '2025-05-04')
INSERT INTO ACTIVIDADES VALUES (4, 2, 'Talleres de memoria', 'Dinámicas para estimular la memoria y concentración', 'Centro de día', '2025-05-04', '2025-06-04')

INSERT INTO ALUMNO_ACTIVIDAD VALUES ('12345678A',1,1)
INSERT INTO ALUMNO_ACTIVIDAD VALUES ('87654321B',1,2)
INSERT INTO ALUMNO_ACTIVIDAD VALUES ('23456789C',1,1)
INSERT INTO ALUMNO_ACTIVIDAD VALUES ('98765432D',1,2)

INSERT INTO PROYECTO_ODS VALUES (1, 1)
INSERT INTO PROYECTO_ODS VALUES (2, 2)

INSERT INTO ALUMNO_TIPO VALUES ('12345678A', 'Voluntariado Social')
INSERT INTO ALUMNO_TIPO VALUES ('87654321B', 'Voluntariado Ambiental')

INSERT INTO PROYECTOS_TIPOS VALUES (1, 'Voluntariado Educativo')
INSERT INTO PROYECTOS_TIPOS VALUES (1, 'Voluntariado Cultural')
INSERT INTO PROYECTOS_TIPOS VALUES (2, 'Voluntariado Deportivo')
INSERT INTO PROYECTOS_TIPOS VALUES (2, 'Voluntariado en Salud')


GO
CREATE PROCEDURE AñadirActividad 
    @IDPROYECTO SMALLINT,
    @IDACTIVIDAD SMALLINT,
    @NOMBRE NVARCHAR(25),
    @DESCRIPCION TEXT,
    @UBICACION NVARCHAR(255),
    @FECHAINICIO DATETIME,
    @FECHAFIN DATETIME
AS
BEGIN
    INSERT INTO ACTIVIDADES (
        IDPROYECTO, 
        IDACTIVIDAD, 
        NOMBRE, 
        DESCRIPCION, 
        UBICACION, 
        FECHA_INICIO, 
        FECHA_FIN
    )
    VALUES (
        @IDPROYECTO, 
        @IDACTIVIDAD, 
        @NOMBRE, 
        @DESCRIPCION, 
        @UBICACION, 
        @FECHAINICIO, 
        @FECHAFIN
    )
END
